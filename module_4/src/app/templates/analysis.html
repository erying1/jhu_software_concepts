{% extends "base.html" %}

{% block title %}Data Analysis{% endblock %}

{% block extra_css %}
<style>
    .spinner-overlay {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(255,255,255,0.8);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
    }
    
    .question {
        font-weight: 600;
        margin-top: 25px;
    }
    .answer {
        margin-left: 10px;
        margin-bottom: 10px;
    }
</style>

<script>
    function showSpinner() {
        document.getElementById("spinner").style.display = "flex";
    }

    function startLoadProgress(event) {
        event.preventDefault();

        const overlay = document.getElementById("load-progress-overlay");
        const bar = document.getElementById("load-progress-bar");
        const label = document.getElementById("progress-stage-label");

        overlay.style.display = "flex";

        let width = 0;

        // Stage durations
        const scrapeTime = 800;   // 0–30%
        const cleanTime  = 800;   // 30–60%
        const loadTime   = 1200;  // 60–99%

        // Stage 1: Scraping
        label.textContent = "Scraping new entries…";
        const stage1 = setInterval(() => {
            width += 1;
            if (width >= 30) {
                clearInterval(stage1);
                stage2();
            }
            bar.style.width = width + "%";
        }, scrapeTime / 30);

        // Stage 2: Cleaning
        function stage2() {
            label.textContent = "Cleaning data…";
            const stage2 = setInterval(() => {
                width += 1;
                if (width >= 60) {
                    clearInterval(stage2);
                    stage3();
                }
                bar.style.width = width + "%";
            }, cleanTime / 30);
        }

        // Stage 3: Loading
        function stage3() {
            label.textContent = "Loading into database…";
            const stage3 = setInterval(() => {
                width += 1;
                if (width >= 99) {
                    clearInterval(stage3);
                }
                bar.style.width = width + "%";
            }, loadTime / 39);
        }

        // Submit form after animation begins
        setTimeout(() => {
            event.target.submit();
        }, 300);
    }
</script>

{% endblock %}

{% block header %}
Grad School Café Data Analysis
{% endblock %}

{% block content %}

<div id="spinner" class="spinner-overlay">
    <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;"></div>
</div>

<div id="load-progress-overlay" class="spinner-overlay" style="display:none;">
    <div style="width: 300px;">
        <div class="progress">
            <div id="load-progress-bar"
                 class="progress-bar progress-bar-striped progress-bar-animated"
                 role="progressbar"
                 style="width: 0%;">
            </div>
        </div>
        <p id="progress-stage-label" class="text-center mt-2">Scraping for new data…</p>
    </div>
</div>

<!-- Button explanations required by assignment -->
<div class="mb-3">
    <small class="text-secondary d-block">
        <strong>Pull Data</strong> scrapes new Grad Café entries using your Module 2 code and loads them into the database.
    </small>
    <small class="text-secondary d-block">
        <strong>Update Analysis</strong> refreshes the analysis using the latest data, unless a data pull is currently running.
    </small>
</div>

<!-- Buttons -->
<div class="d-flex justify-content-between mb-4">

    <!-- Pull Data (left) -->
    <form method="POST" action="{{ url_for('main.pull_data') }}" onsubmit="return startLoadProgress(event)">
        <button class="btn btn-primary" {% if pull_running %}disabled{% endif %}>Pull Data</button>
    </form>



    <!-- Update Analysis (right) -->
    <form method="POST" action="{{ url_for('main.update_analysis') }}" onsubmit="showSpinner()">
        <button class="btn btn-secondary">Update Analysis</button>
    </form>

</div>

<!-- Flash messages -->
{% with messages = get_flashed_messages() %}
  {% if messages %}
    <div class="alert alert-info">
        {% for msg in messages %}
            <div>{{ msg }}</div>
        {% endfor %}
    </div>
  {% endif %}
{% endwith %}

{% if last_data_pull %}
    <p><strong>Last data pull:</strong> {{ last_data_pull }}</p>
{% else %}
    <p><strong>Last data pull:</strong> No data pull has been run yet.</p>
{% endif %}

<p><strong>Last analysis refresh:</strong> {{ results.timestamp }}</p>

<h2 class="mt-4">Analysis</h2>
<!-- Q1 -->
<div class="question">How many entries do you have in your database who have applied for Fall 2026?</div>
<div class="answer"><em>Answer: <strong>Applicant count:</strong> {{ results.fall_2026_count }}</em></div>

<!-- Q2 -->
<div class="question">What percentage of entries are from International students (not American or Other)?</div>
<div class="answer"><em>Answer: <strong>Percent International:</strong> {{ pct(results.pct_international) }}%</em></div>

<!-- Q3 -->
<div class="question">What is the average GPA, GRE, GRE V, and GRE AW of applicants who provided these metrics?</div>
<div class="answer">
    <em>Answer:
    <strong>Average GPA:</strong> {{ fmt(results.avg_metrics[0]) }},
    <strong>Average GRE:</strong> {{ fmt(results.avg_metrics[1]) }},
    <strong>Average GRE V:</strong> {{ fmt(results.avg_metrics[2]) }},
    <strong>Average GRE AW:</strong> {{ fmt(results.avg_metrics[3]) }}</em>
</div>

<!-- Q4 -->
<div class="question">What is the average GPA of American students in Fall 2026?</div>
<div class="answer"><em>Answer: <strong>Average GPA American:</strong> {{ fmt(results.avg_gpa_american) }}</em></div>

<!-- Q5 -->
<div class="question">What percent of entries for Fall 2026 are Acceptances?</div>
<div class="answer"><em>Answer: <strong>Acceptance percent:</strong> {{ pct(results.pct_accept_fall_2026) }}%</em></div>

<!-- Q6 -->
<div class="question">What is the average GPA of Fall 2026 Acceptances?</div>
<div class="answer"><em>Answer: <strong>Average GPA Acceptance:</strong> {{ fmt(results.avg_gpa_accept_fall_2026) }}</em></div>

<!-- Q7 -->
<div class="question">How many entries applied to JHU for a Masters in CS?</div>
<div class="answer"><em>Answer: <strong>JHU CS Masters applicants:</strong> {{ results.jhu_cs_masters }}</em></div>

<!-- Q8 -->
<div class="question">How many acceptances to Georgetown/MIT/Stanford/CMU for CS PhD (Fall 2026)?</div>
<div class="answer"><em>Answer: <strong>Top CS PhD acceptances:</strong> {{ results.top_schools_accept }}</em></div>

<!-- Q9 -->
<div class="question">How many acceptances to top CS PhD programs using LLM‑generated fields?</div>
<div class="answer"><em>Answer: <strong>Top CS PhD acceptances (LLM fields):</strong> {{ results.top_schools_accept_llm }}</em></div>


<hr class="mt-5">

<h3>Additional Questions</h3>

<!-- Top Universities -->
<div class="question">Which universities receive the most applications?</div>
<table class="table table-bordered w-50">
    <thead>
        <tr>
            <th>University</th>
            <th>Total Applications</th>
        </tr>
    </thead>
    <tbody>
    {% for uni, count in results.top_universities %}
        <tr>
            <td>{{ uni }}</td>
            <td>{{ count }}</td>
        </tr>
    {% endfor %}
    </tbody>
</table>

<!-- Acceptance Rate by Degree -->
<div class="question">What is the acceptance rate by degree type?</div>
<table class="table table-bordered w-50">
    <thead>
        <tr>
            <th>Degree</th>
            <th>Total Entries</th>
            <th>Acceptances</th>
            <th>Acceptance Rate (%)</th>
        </tr>
    </thead>
    <tbody>
    {% for degree, total, accepts, rate in results.acceptance_by_degree %}
        <tr>
            <td>{{ degree }}</td>
            <td>{{ total }}</td>
            <td>{{ accepts }}</td>
            <td>{{ rate }}</td>
        </tr>
    {% endfor %}
    </tbody>
</table>

<div class="card mt-4">
    <div class="card-header bg-info text-white">
        Scraper Diagnostic Panel
    </div>
    <div class="card-body">
        <table class="table table-bordered table-sm">
            <tbody>
                {% for key, value in scraper_diag.items() %}
                <tr>
                    <td>{{ key }}</td>
                    <td>
                        {% if "missing" in key and value > 0 %}
                            <span class="text-danger">{{ value }}</span>
                        {% else %}
                            <span class="text-success">{{ value }}</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>


{% endblock %}
