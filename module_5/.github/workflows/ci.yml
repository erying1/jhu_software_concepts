name: Module 5 Tests

on:
  push:
    paths:
      - "module_5/**"
  pull_request:
    paths:
      - "module_5/**"

jobs:
  tests:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: studentCourses
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          cd module_5
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create .env file for coverage
        run: |
          cd module_5
          cp .env.example .env

      # Step 1: Run Pylint (fail if score < 10)
      - name: Run Pylint
        run: |
          cd module_5
          pylint src --fail-under=10

      # Step 2: Generate dependency.svg (fail if missing)
      - name: Install Graphviz
        run: sudo apt-get update && sudo apt-get install -y graphviz

      - name: Generate dependency graph
        run: |
          cd module_5
          pydeps src/run.py --noshow -T svg -o dependency.svg
          if [ ! -f dependency.svg ]; then
            echo "Error: dependency.svg not generated"
            exit 1
          fi

      # Step 3: Run Snyk test
      - name: Run Snyk security scan
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          cd module_5
          npm install -g snyk
          snyk auth $SNYK_TOKEN || echo "Snyk auth skipped (token not set)"
          snyk test --all-projects || echo "Snyk scan completed with findings"

      # Step 4: Run pytest (fail if coverage < 98%)
      - name: Run pytest
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: studentCourses
          DB_USER: postgres
          DB_PASSWORD: postgres
        run: |
          cd module_5
          pytest --cov=src --cov-report=term-missing --cov-fail-under=98
